jQuery(function($){


// Transforme une date au format 20193012 (pour le 30 decembre 2019) en string -> "30/12/2019"
function formateDate(dateSTRING){
  var year = dateSTRING.slice(0,4);
  var month = dateSTRING.slice(4,6);
  var day = dateSTRING.slice(6,8);
  var dateComplete = day+'/'+month+'/'+year;
  return dateComplete;
}


function formateDateVirgule(dateSTRING){
  var year = dateSTRING.slice(0,4);
  var month = dateSTRING.slice(4,6);
  var day = dateSTRING.slice(6,8);
  var dateComplete = year+','+month+','+day;
  return dateComplete;
}

/**
* Gère le trie sur la page archive de formation
* Trie automatique en function du hash dans l'URL
*/
var filterFormations = {
  hashId : null,
  init : function(){
    this.checkHash();
    this.filterOnClick();
  },
  filterOnClick : function(){ 
    $('.btn-filter').click(function(e){
      e.preventDefault();
      $('.btn-filter').removeClass('active');
      $(this).addClass('active');
      var filter = $(this).data('filter');

      $('.article-formation').hide();
      $('.'+filter).fadeIn();
      window.location.hash = filter;
    });
  },
  checkHash : function(){
    if (/#/.test(window.location.href)){
      var url = window.location.href;
      var id = url.split("#");
      this.hashId = id[1];
      this.hideShowArticle();
    }
  },
  hideShowArticle : function(){
    $('.article-formation').hide();
    $('.'+this.hashId).show();
  }
};
filterFormations.init();

var loi =  $.cookie('loi-cookie'); // on lit le cookie
if (loi !== "ok"){ // si le cookie ne contient pas "ok"

$("body").append('<div class="cookie-bar">En poursuivant votre navigation sur ce site, vous acceptez l’utilisation de Cookies pour réaliser des statistiques de visites anonymes. <button class="cookie-accept"> OK </button></div>'); // on affiche la barre de cookie

$('.cookie-bar').on('click', '.cookie-accept', function(){ // quand on clique sur le bouton accepté
  $('.cookie-bar').fadeOut(); // on fait disparaitre la barre
  $.cookie('loi-cookie', 'ok', { expires: 30*13 }); // on met un cookie et on fixe le délais d'expération
});



}

/**
* AU click sur la checkbox J'ai un compte ou affiche / cache l'input email
* */
$('.checkbox-account').click(function(){
  if($(this).is(':checked')){
    $(this).parent().toggleClass('no-border-bottom');
    $(".already-account").fadeToggle();
    $(".new-account").slideToggle();

    // $("input[type='submit']").attr('value','Se connecter et s\'inscrire');
  }else{
    $(this).parent().toggleClass('no-border-bottom');
    $(".already-account").fadeToggle();
    $(".new-account").slideToggle();
    // $("input[name='user_pass2']").toggle();
    // $("input[type='submit']").attr('value','S\'enregistrer');
  }
});

$('.etape-cta').click(function(){
  var $hidenContent = $(this).parent().find('.more-content');
  $hidenContent.slideToggle().toggleClass('showed');

  if($hidenContent.hasClass('showed')){
    $(this).text('').text('Fermer');
  }else{
    $(this).text('').text('Découvrir');
  }
});


// Montre le bouton en savoir plus uniquement si il y'a un contenu caché dans l'article
function seekAndShowBtn(ctaClass){
  var $popi = $(ctaClass).parent().find('.more-content');
  $popi.each(function(){
    $popi.closest('article').find(ctaClass).removeClass('hidden');
  });
}

seekAndShowBtn('.show-cta-savoir-plus');
seekAndShowBtn('.actu-cta');

 

$('.actu-cta').click(function(){
  var $hidenContent = $(this).parent().find('.more-content');
  $hidenContent.slideToggle().toggleClass('showed');

  if($hidenContent.hasClass('showed')){
    $(this).text('').text('Fermer');
  }else{
    $(this).text('').text('En savoir +');
  }
});


var arrowDown = "<img src=' "+abTemplateUrl+"/img/icons/small-arrow-white.png'>";
var arrowUp = "<img src=' "+abTemplateUrl+"/img/icons/small-arrow-white-up.png'>";

$('.show-cta-savoir-plus').click(function(){
  var $hidenContent = $(this).parent().find('.more-content');
  $hidenContent.slideToggle().toggleClass('showed');

  if($hidenContent.hasClass('showed')){
    $(this).text('').text('Réduire');
    $(this).append(arrowUp);
  }else{
    $(this).text('').text('En savoir plus');
    $(this).append(arrowDown);
  }
});

$('#download-pdf').on('click',function(){
  $('.pdf-form').trigger('submit');
});

var hashTagActive = "";
$(".scroll").click(function (event) {
  if(hashTagActive != this.hash) { //this will prevent if the user click several times the same link to freeze the scroll.
    event.preventDefault();
    //calculate destination place
    var dest = 0;
    if ($(this.hash).offset().top > $(document).height() - $(window).height()) {
      dest = $(document).height() - $(window).height();
    } else {
      dest = $(this.hash).offset().top;
    }
    //go to destination
    $('html,body').animate({
      scrollTop: dest
    }, 2000, 'swing');
    hashTagActive = this.hash;
  }
});


// Page de recherche Highlight du mot cherché
var searchedWord = $('#searchedWord').text();
if(searchedWord !== "undefined" && searchedWord !== ""){
  $('.search article:not(a)').highlight(searchedWord);
}

// droite droite, B, A, droite droite
var k = [ 39,39, 66, 65,39,39],
n = 0;
$(document).keydown(function (e) {
  if (e.keyCode === k[n++]) {
    if (n === k.length) {
      // run
      $('body').append('<a class="popup-youtube" href="https://www.youtube.com/watch?v=StrmHI3MCAU" style="display:none;"></a>');
      $('.popup-youtube, .popup-vimeo, .popup-gmaps').magnificPopup({
        disableOn: 700,
        type: 'iframe',
        mainClass: 'mfp-fade',
        removalDelay: 160,
        preloader: false,
        fixedContentPos: false
      });
      $('.popup-youtube').trigger('click');
      $('body').append('<style>.mfp-iframe-holder {position: fixed;}');
      // run
      n = 0;
      return false;
    }
  }
  else {
    n = 0;
  }
});

$('.calendar').first().addClass('first');
$('.calendar').last().addClass('last');

$('table').first().toggleClass('tab-hide');

$('.next').click(function(e){
  e.preventDefault();
  var $calendar = $(this).closest('.calendar');
  if($calendar.hasClass('last')) return false;
  $calendar.toggleClass('tab-hide');
  $calendar.next().toggleClass('tab-hide');

});

$('.prev').click(function(e){
  e.preventDefault();
  var $calendar = $(this).closest('.calendar');
  if($calendar.hasClass('first')) return false;
  $calendar.toggleClass('tab-hide');
  $calendar.prev().toggleClass('tab-hide');
});

console.log('hello');

// récupère les sessions du CPT session entre dateEnd et dateStart
var getSession = {
  init : function(){
    this.sendRequest();
  },
  sendRequest : function(){
    that = this;
    $.ajax({
      type: "POST",
      url: ajaxurl,
      dataType : 'json',
      async: true,
      timeout:5000,
      data:{
        action: 'get_session',
        dateEnd: "20401201",
        dateStart: "20100401"
      },
      success: function(response){
        // console.log(response);
        that.fillCalendar(response);

      },
      error : function(request, errorType, errorMessage){
        console.log(request);
        console.log(errorType);
        console.log(errorMessage);
      },
      beforeSend: function(){
        //alert('Avant la requête AJAX');
        // $('#comments-btn').after("<i id='ajax-loader' class='fa fa-refresh fa-spin fa-2x ajax-loader'></i>");
      },
      complete:function(){
        //$('#ajax-loader').remove();
      }
    });
  },
  fillCalendar : function(ajaxData){
    InjectCalendar.init(ajaxData);
  }
};

// Si on est sur une page avec le calendar
if( $('.calendar').length > 0) getSession.init();

// Injecte les dates récupéré par getSession dans le datepicker
var InjectCalendar = {
  myAjax : null,
  init : function(ajaxData){
    this.setCalendar(ajaxData);
  },
  setCalendar : function(ajaxData){
    console.log(ajaxData); // ajaxData contient les dates et les id des posts
    for(i = 0; i < ajaxData.length; i++){ // on boucle sur l'objet pour créer 2 autres object (eventDate et session)
    // console.log(ajaxData[i].id);
    var year = ajaxData[i].date.slice(0,4);
    var month = ajaxData[i].date.slice(4,6);
    var day = ajaxData[i].date.slice(6,8);

    var taxo = ajaxData[i].themes[0];

    var dateComplete = month+'/'+day+'/'+year;

    var dateClass = '.'+year+month+day;
    console.log(dateClass);

    if($(dateClass).attr('data-session') !== ""){ // si une session est deja rentrée
      var sessionAlreadyAdded = $(dateClass).attr('data-session'); // on récupère la session deja en place
      $(dateClass).addClass('multiple-session').attr('data-session',sessionAlreadyAdded+' '+ajaxData[i].id); // on ajoute une class speciale et on rajoute l'id

    }else if( taxo == "formation-pharmacie-hospitaliere"){
      $(dateClass).addClass('session formation-pharmacie-hospitaliere').attr('data-session',ajaxData[i].id);

    }else if(taxo == "seminaires"){
      $(dateClass).addClass('session seminaire').attr('data-session',ajaxData[i].id);
      if(typeof(ajaxData[i].category) !== "undefined") $(dateClass).addClass(ajaxData[i].category[0]);

    }else{
      $(dateClass).addClass('session').attr('data-session',ajaxData[i].id);
    }

  }
  this.listenClickLoadSession();
},
listenClickLoadSession : function(){
  var that = this;
  $('.calendar .days td').on('click',function(){
    var sessionId = $(this).data('session');

    if(sessionId === "") return false; // si le click est sur une date vide on retourne

    if(that.isMultipleSession(sessionId)){
      var sessionArray = that.sliceSessionId(sessionId);
      loadSession.sendRequest(sessionArray);
    }else{
      loadSession.sendRequest(sessionId);
    }

    that.firePopin();
  });
},
isMultipleSession : function(element){
  if( typeof(element) == 'string' && element.length > 0){
    return true;
  }else{
    return false;
  }
},
sliceSessionId : function(sessionId){
  var sessionsArray = sessionId.split(' ').map(Number); // /!\ Attention support old browser !
  return sessionsArray;
},
firePopin : function(){

  $('.open-popup-link').magnificPopup({
    type:'inline',
    midClick: true
  });
  $('.open-popup-link').trigger('click');

},
adjustPopinHeight : function(){
  var popinHeight = $('.popin').height();
  if(popinHeight > 300){
    $('.popin').css('margin-top',(popinHeight*-1)/2);
  }else{
    $('.popin').css('margin-top',(popinHeight*-1)/2);
  }
}
};


// Envoie une requête pour récupérer les infos d'une session
// Cette requête renvoit un objet contenant les infos
// fillPopin remplis une popin et la déclenhce après que les infos ai été injecté dans le doc
var loadSession = {

  sendRequest : function(postId){
    that = this;
    $.ajax({
      type: "POST",
      url: ajaxurl,
      dataType : 'json',
      async: true,
      timeout:5000,
      data:{
        action: 'load_session',
        postId: postId
      },
      success: function(response){
        that.fillPopin(response);
      },
      error : function(request, errorType, errorMessage){
        console.log(request);
        console.log(errorType);
        console.log(errorMessage);
      },
      beforeSend: function(){
        $('#ajax-loader').show();
        $('.pop-i').remove();
        //alert('Avant la requête AJAX');
        // $('#comments-btn').after("<i id='ajax-loader' class='fa fa-refresh fa-spin fa-2x ajax-loader'></i>");
      },
      complete:function(){
        $('#ajax-loader').hide();
      }
    });
  },
  isSingleResponse : function(response){
    if(response.single === true){
      return true;
    }else{
      return false;
    }
  },
  fillSinglePopin : function(response){
    $('.pop-i').remove();
    var tarifs = response.tarifs.join();tarifs = tarifs.replace(",", " ");tarifs = tarifs.replace(",", " ");  tarifs = tarifs.replace("</li>,","</li>");

    $('.popin-inside-container').append(' <div class="pop-i row resume"> <div class="col-md-12"> <div class="category-title"><div class="list-type '+response.taxoColor+'"></div> '+response.themes[0]+' </div><div class="h2">'+response.title+'</div><hr> <div class="h3">Résumé des informations</div><hr> <div class="row"> <div class="col-md-6"> <div class="session-info"><strong> Durée : </strong>'+response.duree+'</div><div class="session-info"><strong> Code : </strong>'+response.code+'</div><div class="session-info"><strong> Lieu : </strong>'+response.lieu+'</div></div><div class="col-md-6"> <div class="session-info date"><strong> Date : </strong>'+response.post_title+'</div><div class="session-info"><strong> Tarifs : </strong> <ul>'+tarifs+'</ul> </div></div></div><hr> <a href="'+response.url+'" class="btn ">Accéder au programme</a> </div></div>');

    InjectCalendar.adjustPopinHeight();
  },
  fillMultiplePopin : function(response){
    $('.pop-i').remove();
    for (i = 0; i < response.length; i++) {
      console.log(response);

      var tarifs = response[i].tarifs.join();tarifs = tarifs.replace(",", " ");tarifs = tarifs.replace("</li>,","</li>");

      $('.popin-inside-container').append(' <div class="pop-i row resume"> <div class="col-md-12"> <div class="category-title"><div class="list-type '+response[i].taxoColor+'"></div>  '+response[i].themes[0]+'</div><div class="h2">'+response[i].title+'</div><hr> <div class="h3">Résumé des informations</div><hr> <div class="row"> <div class="col-md-6"> <div class="session-info"><strong> Durée : </strong>'+response[i].duree+'</div><div class="session-info"><strong> Code : </strong>'+response[i].code+'</div><div class="session-info"><strong> Lieu : </strong>'+response[i].lieu+'</div></div><div class="col-md-6"> <div class="session-info date"><strong> Date : </strong>'+response[i][0].post_title+'</div><div class="session-info"><strong> Tarifs : </strong> <ul>'+tarifs+'</ul> </div></div></div><hr> <a href="'+response[i].url+'" class="btn ">Accéder au programme</a> </div></div>');
    }
    InjectCalendar.adjustPopinHeight();
  },
  fillPopin : function(response){
    console.log(response);

    if(this.isSingleResponse(response)){
      this.fillSinglePopin(response);
    }else{
      //console.log(response);
      this.fillMultiplePopin(response);

    }

    //.log(response.post_content);

  }
};


/**
* Formulaire de demande de documentation
*/

$('#askdoc-form').on('click',function(e){
  e.preventDefault();

  //var nom = $( "input[name*='nom']" ).val();
  var email = $( ".askdoc-form input[name='email']" ).val();

  //return false;
  var $this = $(this);
  //$(this).addClass("done");

  $.ajax({
    type: "POST",
    url: ajaxurl,
    async: true,
    timeout:5000,
    dataType: 'json', // JSON
    data:{
      action: 'form_askdoc',
      //nom: nom,
      email: email
    },
    success: function(data){
      //this.afterAjaxCall();
      console.log(data);
      $('.erreur').remove();

      if(!data.erreur){

        $this.after("<p class='send-ok'><i class='fa fa-check'></i> Demande de catalogue parfaitement envoyée !</p>");

      }else{
        console.log(data);

        if(data.erreurEmail) $('#askdoc-form').after(data.erreurEmail);

        //if(data.erreurNom) $( "input[name*='nom']" ).after(data.erreurNom);

        if(data.erreurEmailDoublon) $('#askdoc-form').after(data.erreurEmailDoublon);

      }
    },
    error : function(request, errorType, errorMessage){
      console.log(request);
      console.log(errorType);
      console.log(errorMessage);
    },
    beforeSend: function(){
      //alert('Avant la requête AJAX');
      $('#contact-form').after("<i id='ajax-loader' class='fa fa-refresh fa-spin fa-2x ajax-loader'></i>");
    },
    complete:function(){
      $('#ajax-loader').remove();
    }
  });
});
// fin formulaire de demande de documentation

// Formulaire Contact

$('#contact-form').on('click',function(e){
  e.preventDefault();

  var nom = $( ".info-pratique input[name*='nom']" ).val();
  var prenom = $( ".info-pratique input[name='prenom']" ).val();
  var fonction = $( ".info-pratique input[name='fonction']" ).val();
  var telephone = $( ".info-pratique input[name*='telephone']" ).val();
  var email = $( ".info-pratique input[name*='email']" ).val();
  var formation = $( ".info-pratique input[name*='formation']" ).val();
  var dateFormation = $( ".info-pratique input[name*='dateformation']" ).val();
  var message = $( ".info-pratique textarea[name*='message']" ).val();

  //return false;
  var $this = $(this);

  $.ajax({
    type: "POST",
    url: ajaxurl,
    async: true,
    timeout:5000,
    dataType: 'json', // JSON
    data:{
      action: 'form_rapide',
      nom: nom,
      prenom: prenom,
      fonction: fonction,
      telephone: telephone,
      email: email,
      formation: formation,
      dateFormation: dateFormation,
      message: message
    },
    success: function(data){
      //this.afterAjaxCall();
      console.log(data);
      $('.erreur').remove();

      if(!data.erreur){

        $this.after("<p class='send-ok'>Vos questions ont bien été envoyées, nous vous remercions. Pour être prises en compte, il faut que vous soyez inscrit à la formation.</p>");
        $('.info-pratique input, textarea').each(function(){
          $(this).val('');
        });

      }else{

        if(data.erreurEmail) $( ".info-pratique input[name*='email']" ).after(data.erreurEmail);

        if(data.erreurNom) $( ".info-pratique input[name='nom']" ).after(data.erreurNom);

        if(data.erreurPrenom) $( ".info-pratique input[name='prenom']" ).after(data.erreurPrenom);

        if(data.erreurTelephone) $( ".info-pratique input[name*='telephone']" ).after(data.erreurTelephone);

        if(data.erreurFormation) $( ".info-pratique input[name='formation']" ).after(data.erreurFormation);

        if(data.erreurFonction) $( ".info-pratique input[name='fonction']" ).after(data.erreurFonction);

        if(data.erreurDateFormation) $( ".info-pratique input[name='dateformation']" ).after(data.erreurDateFormation);

        if(data.erreurMessage) $( ".info-pratique textarea[name*='message']" ).after(data.erreurMessage);

      }
    },
    error : function(request, errorType, errorMessage){
      console.log(request);
      console.log(errorType);
      console.log(errorMessage);
    },
    beforeSend: function(){
      //alert('Avant la requête AJAX');
      $('#contact-form').after("<i id='ajax-loader' class='fa fa-refresh fa-spin fa-2x ajax-loader'></i>");
    },
    complete:function(){
      $('#ajax-loader').remove();
    }
  });
});
// fin formulaire de contact

// Formulaire Newsletter
$('#newsletter-form-btn').on('click',function(e){
  e.preventDefault();

  //var nom = $( ".newsletter-form input[name*='nom']" ).val();
  //var prenom = $( ".newsletter-form input[name='prenom']" ).val();
  var email = $( ".newsletter-form input[name*='email']" ).val();

  //return false;
  var $this = $(this);

  $.ajax({
    type: "POST",
    url: ajaxurl,
    async: true,
    timeout:5000,
    dataType: 'json', // JSON
    data:{
      action: 'form_newsletter',
      // nom: nom,
      // prenom: prenom,
      email: email
    },
    success: function(data){
      //this.afterAjaxCall();
      console.log(data);
      $('.erreur').remove();

      if(!data.erreur){

        $this.after("<p class='send-ok'><i class='fa fa-check'></i> Votre inscription a été effectuée ; nous vous en remercions</p>");

      }else{

        if(data.erreurEmail) $( ".newsletter-form" ).after(data.erreurEmail);

        // if(data.erreurNom) $( "input[name='nom']" ).after(data.erreurNom);

        // if(data.erreurPrenom) $( "input[name='prenom']" ).after(data.erreurPrenom);

      }
    },
    error : function(request, errorType, errorMessage){
      console.log(request);
      console.log(errorType);
      console.log(errorMessage);
    },
    beforeSend: function(){
      //alert('Avant la requête AJAX');
      $('#newsletter-form-btn').after("<i id='ajax-loader' class='fa fa-refresh fa-spin fa-2x ajax-loader'></i>");
    },
    complete:function(){
      $('#ajax-loader').remove();
    }
  });
});
// fin formulaire de contact

// Formulaire Contact


$('#session-form').on('click',function(e){
  e.preventDefault();

  // Créer un compte
  var user_email = $( "#register-form input[name='user_email']" ).val();
  var user_pass = $( "#register-form input[name='user_pass']" ).val();
  var user_pass2 = $( "#register-form input[name='user_pass2']" ).val();


  // Participant

  // genre
  var participant_mme = $( "input[name='participant_mme']" ).is(':checked');
  var participant_mr = $( "input[name='participant_mr']" ).is(':checked');
  var participant_dr = $( "input[name='participant_dr']" ).is(':checked');
  var participant_rpps = $( "input[name='participant_rpps']" ).val();
  var nom = $( "input[name='participant_nom']" ).val();
  var participant_prenom = $( "input[name='participant_prenom']" ).val();
  var participant_telephone = $( "input[name='participant_telephone']" ).val();
  var participant_fax = $( "input[name='participant_fax']" ).val();
  var participant_fonction = $( "input[name='participant_fonction']" ).val();

  // Entreprise
  var entreprise_nom = $( "input[name='entreprise_nom']" ).val();
  var entreprise_adresse = $( "input[name='entreprise_adresse']" ).val();

  // Responsable Formation
  var responsable_nom = $( "input[name='responsable_nom']" ).val();
  var responsable_prenom = $( "input[name='responsable_prenom']" ).val();
  var responsable_adresse = $( "input[name='responsable_adresse']" ).val();
  var responsable_telephone = $( "input[name='responsable_telephone']" ).val();
  var responsable_email = $( "input[name='responsable_email']" ).val();

  // Prise en charge de la formation
  var pee_entreprise = $( "input[name='pee_entreprise']" ).is(':checked');
  var pee_adresse_facturation = $( "input[name='pee_adresse_facturation']" ).val();
  var pee_num_commande = $( "input[name='pee_num_commande']" ).val();

  var pee_organisme_payeur = $( "input[name='pee_organisme_payeur']" ).is(':checked');
  var pee_nom_organisme = $( "input[name='pee_nom_organisme']" ).val();
  var pee_adresse_organisme = $( "input[name='pee_adresse_organisme']" ).val();
  var pee_telephone_organisme = $( "input[name='pee_telephone_organisme']" ).val();
  var pee_fax_organisme = $( "input[name='pee_fax_organisme']" ).val();
  var conditions_generales = $( "input[name='conditions_generales']" ).is(':checked');

  // Hiden
  var formation_id = $( "input[name='formation_id']" ).val();

  console.log('_______');
  // console.log('pee_entreprise '+pee_entreprise);
  // console.log('pee_organisme_payeur'+pee_organisme_payeur);
  console.log('conditions_generales '+conditions_generales);
  console.log('_______');


  //return false;
  var $this = $(this);

  $.ajax({
    type: "POST",
    url: ajaxurl,
    async: true,
    timeout:5000,
    dataType: 'json', // JSON
    data:{
      action: 'form_session',

      // Créer un compte
      user_email : user_email,
      user_pass : user_pass,
      user_pass2 : user_pass2,

      // PArticipant
      participant_mme : participant_mme,
      participant_mr : participant_mr,
      participant_dr : participant_dr,
      participant_rpps : participant_rpps,

      participant_nom : nom,
      participant_prenom : participant_prenom,
      participant_telephone : participant_telephone,
      participant_fax : participant_fax,
      participant_fonction : participant_fonction,

      // Entreprise
      entreprise_nom : entreprise_nom,
      entreprise_adresse : entreprise_adresse,

      // Responsable Formation
      responsable_nom : responsable_nom,
      responsable_prenom : responsable_prenom,
      responsable_adresse : responsable_adresse,
      responsable_telephone : responsable_telephone,
      responsable_email : responsable_email,

      // Prise en charge

      pee_entreprise : pee_entreprise,
      pee_adresse_facturation : pee_adresse_facturation,
      pee_num_commande : pee_num_commande,


      pee_organisme_payeur :   pee_organisme_payeur,
      pee_nom_organisme : pee_nom_organisme,
      pee_adresse_organisme : pee_adresse_organisme,
      pee_telephone_organisme : pee_telephone_organisme,
      pee_fax_organisme : pee_fax_organisme,

      // Condition Générales
      conditions_generales : conditions_generales,

      // hidden
      formation_id : formation_id

    },
    success: function(data){
      //this.afterAjaxCall();
      console.log(data);
      $('.erreur').remove();
      $('.erreur-global').remove();

      if(!data.erreur && !data.isWpErreur){

        $this.after("<p class='send-ok'><i class='fa fa-check'></i> Inscription OK</p>");

      }else if(data.erreur){

        // Info générale
        $('#session-form').after("<p class='erreur-global'> Des erreurs empèchent la soumission du formulaire. Veuillez corriger les erreurs.</p>");

        // Créer un compte
        if(data.erreur_user_email) $( "#register-form input[name='user_email']" ).after(data.erreur_user_email);
        if(data.erreur_user_pass) $( "#register-form input[name='user_pass2']" ).after(data.erreur_user_pass);


        // Participant
        if(data.erreur_participant_nom) $( "input[name='participant_nom']" ).after(data.erreur_participant_nom);
        if(data.erreur_participant_prenom) $( "input[name='participant_prenom']" ).after(data.erreur_participant_prenom);
        if(data.erreur_participant_telephone) $( "input[name='participant_telephone']" ).after(data.erreur_participant_telephone);
        if(data.erreur_participant_fonction) $( "input[name='participant_fonction']" ).after(data.erreur_participant_fonction);

        // Entreprise
        if(data.erreur_entreprise_nom ) $( "input[name='entreprise_nom']" ).after(data.erreur_entreprise_nom);
        if(data.erreur_entreprise_adresse) $( "input[name='entreprise_adresse']" ).after(data.erreur_entreprise_adresse);

        //Responsable
        if(data.erreur_responsable_nom  ) $( "input[name='responsable_nom']" ).after(data.erreur_responsable_nom);
        if(data.erreur_responsable_prenom) $( "input[name='responsable_prenom']" ).after(data.erreur_responsable_prenom);
        //if(data.erreur_responsable_adresse) $( "input[name='responsable_adresse']" ).after(data.erreur_responsable_adresse);
        if(data.erreur_responsable_telephone) $( "input[name='responsable_telephone']" ).after(data.erreur_responsable_telephone);
        if(data.erreur_responsable_email) $( "input[name='responsable_email']" ).after(data.erreur_responsable_email);

        // Pee
        if(data.erreur_pee_nom_organisme) $( "input[name='pee_nom_organisme']" ).after(data.erreur_pee_nom_organisme);
        if(data.erreur_pee_adresse_organisme) $( "input[name='pee_adresse_organisme']" ).after(data.erreur_pee_adresse_organisme);
        if(data.erreur_pee_telephone_organisme) $( "input[name='pee_telephone_organisme']" ).after(data.erreur_pee_telephone_organisme);

        if(data.erreur_pee) $("#pee_title").after(data.erreur_pee);

        // Conditions générales
        if(data.erreur_condition_generales) $( ".condition_generales" ).after(data.erreur_condition_generales);

      }

      // Affichage erreur WP
      if(data.isWpErreur){
        $('#session-form').after('<p class="erreur-global">'+data.wpErreur+'</p>');
        $( "#register-form input[name='user_email']" ).after('<em class="erreur state-error">'+data.wpErreur+'</em>');
      }

      // Redirection du membre après connection
      if(data.registerOk && !data.isWpErreur  &&!data.erreur && !data.createPage){

        window.location = blogUrl+'/espace-membre/';
      }else if(data.createPage){
        window.location = blogUrl+'/espace-membre/?createpage=true';
      }


    },
    error : function(request, errorType, errorMessage){
      console.log(request);
      console.log(errorType);
      console.log(errorMessage);
    },
    beforeSend: function(){
      //alert('Avant la requête AJAX');
      $('#contact-form').after("<i id='ajax-loader' class='fa fa-refresh fa-spin fa-2x ajax-loader'></i>");
    },
    complete:function(){
      $('#ajax-loader').remove();
    }
  });
});
// fin formulaire de contact


// Tweak sur le form

// Interdiction de 2 choix sur les checkbox

$( "input[name='pee_entreprise']" ).click(function(){
  if($(this).is(':checked')) $( "input[name='pee_organisme_payeur']" ).attr('checked', false); // Unchecks it
});

$( "input[name='pee_organisme_payeur']" ).click(function(){
  if($(this).is(':checked')) $( "input[name='pee_entreprise']" ).attr('checked', false); // Unchecks it
});

// $('.checkbox-gender').on('click',function(){
//   $('.checkbox-gender').attr('checked', false);
//   $(this).attr('checked', true);
// });


$('.checkbox-gender').click(function(){
  $('.checkbox-gender').prop('checked', false);
  $(this).prop('checked', true);
});

// Formulaire Contact
console.log('SO');
$('#register-form-for-members button').on('click',function(e){
  e.preventDefault();

  // Créer un compte
  var user_email = $( "#register-form-for-members input[name='user_email']" ).val();
  var user_pass = $( "#register-form-for-members input[name='user_pass']" ).val();


  // Hiden
  var formation_id = $( "#register-form-for-members input[name='formation_id']" ).val();

  console.log('_______');
  // console.log('pee_entreprise '+pee_entreprise);
  // console.log('pee_organisme_payeur'+pee_organisme_payeur);
  console.log('_______');




  //return false;
  var $this = $(this);

  $.ajax({
    type: "POST",
    url: ajaxurl,
    async: true,
    timeout:5000,
    dataType: 'json', // JSON
    data:{
      action: 'form_session_already_registered',

      // Créer un compte
      user_email : user_email,
      user_pass : user_pass,

      // hidden
      formation_id : formation_id

    },
    success: function(data){
      //this.afterAjaxCall();
      console.log(data);
      $('.erreur').remove();

      if(!data.erreur){

        $('input, textarea').each(function(){
          $(this).val('');
        });

        $('#register-form-for-members').after('<p class="send-ok"> Votre inscription a bien été enregistrée ; vous allez recevoir un mail vous indiquant comment la finaliser . Merci. </p>');

      }else{

        // Créer un compte
        if(data.erreur_user_email) $( "#register-form-for-members input[name='user_email']" ).after(data.erreur_user_email);
        if(data.erreur_user_pass) $( "#register-form-for-members input[name='user_pass']" ).after(data.erreur_user_pass);

        // Affichage erreur WP
        if(data.erreur_wp_msg) $('#register-form-for-members').after('<p class="erreur erreur-global">'+data.erreur_wp_msg+'</p>');

        // Affichage erreur Compte non validé
        if(data.erreur_validation) $('#register-form-for-members').after('<p class="erreur erreur-global">'+data.erreur_validation+'</p>');

      }



    },
    error : function(request, errorType, errorMessage){
      console.log(request);
      console.log(errorType);
      console.log(errorMessage);
    },
    beforeSend: function(){
      //alert('Avant la requête AJAX');
      $('#contact-form').after("<i id='ajax-loader' class='fa fa-refresh fa-spin fa-2x ajax-loader'></i>");
    },
    complete:function(){
      $('#ajax-loader').remove();
    }
  });
});
// fin formulaire de contact

// Formulaire Intra


console.log('Intra Loaded');
$('#intra-form').on('click',function(e){
  e.preventDefault();

  var nom = $( ".intra-form input[name*='nom']" ).val();
  var prenom = $( ".intra-form input[name='prenom']" ).val();

  var societe = $( ".intra-form input[name='societe']" ).val();

  var fonction = $( ".intra-form input[name='fonction']" ).val();
  var telephone = $( ".intra-form input[name='telephone']" ).val();

  var email = $( ".intra-form input[name='email']" ).val();
  var besoin = $( ".intra-form textarea[name='besoin']" ).val();

  var public_concerne = $( ".intra-form input[name='public_concerne']" ).val();
  var periode_envisagee = $( ".intra-form input[name='periode_envisagee']" ).val();

  //return false;
  var $this = $(this);

  $.ajax({
    type: "POST",
    url: ajaxurl,
    async: true,
    timeout:5000,
    dataType: 'json', // JSON
    data:{
      action: 'form_intra',
      nom: nom,
      prenom: prenom,
      societe : societe,
      fonction: fonction,
      telephone: telephone,
      email: email,
      besoin: besoin,
      public_concerne : public_concerne,
      periode_envisagee : periode_envisagee
    },
    success: function(data){
      //this.afterAjaxCall();
      console.log(data);
      $('.erreur').remove();

      if(!data.erreur){

        // On efface tout les champs
        $( ".intra-form input[name='nom']" ).val('');
        $( ".intra-form input[name='prenom']" ).val('');
        $( ".intra-form input[name='societe']" ).val('');
        $( ".intra-form input[name='fonction']" ).val('');
        $( ".intra-form input[name*='telephone']" ).val('');
        $( ".intra-form input[name='email']" ).val('');
        $( ".intra-form [name='besoin']" ).val('');
        $( ".intra-form input[name='public_concerne']" ).val('');
        $( ".intra-form input[name*='periode_envisagee']" ).val('');
        // Message de retour OK
        $this.after("<p class='send-ok'>Votre demande a bien été envoyée, nous vous en remercions.</p>");

      }else{

        if(data.erreurNom) $( ".intra-form input[name='nom']" ).after(data.erreurNom);
        if(data.erreurPrenom) $( ".intra-form input[name='prenom']" ).after(data.erreurPrenom);

        if(data.erreurSociete) $( ".intra-form input[name='societe']" ).after(data.erreurSociete);
        if(data.erreurFonction) $( ".intra-form input[name='fonction']" ).after(data.erreurFonction);


        if(data.erreurTelephone) $( ".intra-form input[name*='telephone']" ).after(data.erreurTelephone);
        if(data.erreurEmail) $( ".intra-form input[name='email']" ).after(data.erreurEmail);

        if(data.erreurBesoin) $( ".intra-form [name='besoin']" ).after(data.erreurBesoin);

        if(data.erreurPublic_concerne) $( ".intra-form input[name='public_concerne']" ).after(data.erreurPublic_concerne);
        if(data.erreurPeriode_envisagee) $( ".intra-form input[name*='periode_envisagee']" ).after(data.erreurPeriode_envisagee);

      }
    },
    error : function(request, errorType, errorMessage){
      console.log(request);
      console.log(errorType);
      console.log(errorMessage);
    },
    beforeSend: function(){
      //alert('Avant la requête AJAX');
      $('#contact-form').after("<i id='ajax-loader' class='fa fa-refresh fa-spin fa-2x ajax-loader'></i>");
    },
    complete:function(){
      $('#ajax-loader').remove();
    }
  });
});
// fin formulaire de contact

// Formulaire Contact
$( ".contact-form textarea" ).one( "click", function() {
  $(this).val('');
});

$('#contact-form-btn').on('click',function(e){
  e.preventDefault();

  var nom = $( ".contact-form input[name*='nom']" ).val();
  var prenom = $( ".contact-form input[name='prenom']" ).val();
  var fonction = $( ".contact-form input[name='fonction']" ).val();
  var telephone = $( ".contact-form input[name*='telephone']" ).val();
  var email = $( ".contact-form input[name*='email']" ).val();
  var message = $( ".contact-form textarea[name*='message']" ).val();

  //return false;
  var $this = $(this);

  $.ajax({
    type: "POST",
    url: ajaxurl,
    async: true,
    timeout:5000,
    dataType: 'json', // JSON
    data:{
      action: 'form_contact',
      nom: nom,
      prenom: prenom,
      fonction: fonction,
      telephone: telephone,
      email: email,
      message: message
    },
    success: function(data){
      //this.afterAjaxCall();
      console.log(data);
      $('.erreur').remove();

      if(!data.erreur){

        $('.contact-form input, textarea').each(function(){
          $(this).val('');
        });

        $this.after("<p class='send-ok'>Nous vous remercions de votre message qui a bien été envoyé</p>");

      }else{

        if(data.erreurEmail) $( ".contact-form input[name*='email']" ).after(data.erreurEmail);

        if(data.erreurNom) $( ".contact-form input[name='nom']" ).after(data.erreurNom);

        if(data.erreurPrenom) $( ".contact-form input[name='prenom']" ).after(data.erreurPrenom);

        if(data.erreurTelephone) $( ".contact-form input[name*='telephone']" ).after(data.erreurTelephone);

        if(data.erreurFonction) $( ".contact-form input[name='fonction']" ).after(data.erreurFonction);


        if(data.erreurMessage) $( ".contact-form textarea[name*='message']" ).after(data.erreurMessage);

      }
    },
    error : function(request, errorType, errorMessage){
      console.log(request);
      console.log(errorType);
      console.log(errorMessage);
    },
    beforeSend: function(){
      //alert('Avant la requête AJAX');
      $('#contact-form').after("<i id='ajax-loader' class='fa fa-refresh fa-spin fa-2x ajax-loader'></i>");
    },
    complete:function(){
      $('#ajax-loader').remove();
    }
  });
});
// fin formulaire de contact

$('#espace-membre-form-btn').on('click',function(e){
  e.preventDefault();

  // Créer un compte
  var user_email = $( "input[name='user_email']" ).val();
  var user_pass = $( "input[name='user_pass']" ).val();
  var user_pass2 = $( "input[name='user_pass2']" ).val();

  // Participant
  // genre
  var participant_mme = $( "input[name='participant_mme']" ).is(':checked');
  var participant_mr = $( "input[name='participant_mr']" ).is(':checked');
  var participant_dr = $( "input[name='participant_dr']" ).is(':checked');
  var participant_rpps = $( "input[name='participant_rpps']" ).val();
  var nom = $( "input[name='participant_nom']" ).val();
  var participant_prenom = $( "input[name='participant_prenom']" ).val();
  var participant_telephone = $( "input[name='participant_telephone']" ).val();
  var participant_fax = $( "input[name='participant_fax']" ).val();
  var participant_fonction = $( "input[name='participant_fonction']" ).val();

  // Entreprise
  var entreprise_nom = $( "input[name='entreprise_nom']" ).val();
  var entreprise_adresse = $( "input[name='entreprise_adresse']" ).val();

  // Responsable Formation
  var responsable_nom = $( "input[name='responsable_nom']" ).val();
  var responsable_prenom = $( "input[name='responsable_prenom']" ).val();
  var responsable_adresse = $( "input[name='responsable_adresse']" ).val();
  var responsable_telephone = $( "input[name='responsable_telephone']" ).val();
  var responsable_email = $( "input[name='responsable_email']" ).val();

  // Prise en charge de la formation
  var pee_entreprise = $( "input[name='pee_entreprise']" ).is(':checked');
  var pee_adresse_facturation = $( "input[name='pee_adresse_facturation']" ).val();
  var pee_num_commande = $( "input[name='pee_num_commande']" ).val();

  var pee_organisme_payeur = $( "input[name='pee_organisme_payeur']" ).is(':checked');
  var pee_nom_organisme = $( "input[name='pee_nom_organisme']" ).val();
  var pee_adresse_organisme = $( "input[name='pee_adresse_organisme']" ).val();
  var pee_telephone_organisme = $( "input[name='pee_telephone_organisme']" ).val();
  var pee_fax_organisme = $( "input[name='pee_fax_organisme']" ).val();

  // user id
  var user_id = $("input[name='user_id']").val();


  console.log('_______');
  // console.log('pee_entreprise '+pee_entreprise);
  // console.log('pee_organisme_payeur'+pee_organisme_payeur);
  //console.log('conditions_generales '+conditions_generales);
  console.log('_______');



  //return false;
  var $this = $(this);

  $.ajax({
    type: "POST",
    url: ajaxurl,
    async: true,
    timeout:5000,
    dataType: 'json', // JSON
    data:{
      action: 'form_espace_membre',

      // Créer un compte
      user_email : user_email,
      user_pass : user_pass,
      user_pass2 : user_pass2,

      // PArticipant
      participant_mme : participant_mme,
      participant_mr : participant_mr,
      participant_dr : participant_dr,
      participant_rpps : participant_rpps,

      participant_nom : nom,
      participant_prenom : participant_prenom,
      participant_telephone : participant_telephone,
      participant_fax : participant_fax,
      participant_fonction : participant_fonction,

      // Entreprise
      entreprise_nom : entreprise_nom,
      entreprise_adresse : entreprise_adresse,

      // Responsable Formation
      responsable_nom : responsable_nom,
      responsable_prenom : responsable_prenom,
      responsable_adresse : responsable_adresse,
      responsable_telephone : responsable_telephone,
      responsable_email : responsable_email,

      // Prise en charge

      pee_entreprise : pee_entreprise,
      pee_adresse_facturation : pee_adresse_facturation,
      pee_num_commande : pee_num_commande,


      pee_organisme_payeur :   pee_organisme_payeur,
      pee_nom_organisme : pee_nom_organisme,
      pee_adresse_organisme : pee_adresse_organisme,
      pee_telephone_organisme : pee_telephone_organisme,
      pee_fax_organisme : pee_fax_organisme,

      // user_id
      user_id : user_id


    },
    success: function(data){
      //this.afterAjaxCall();
      console.log(data);
      $('.erreur').remove();
      $('.send-ok').remove();
      $('.erreur-global').remove();

      if(!data.erreur && !data.isWpErreur){

        $this.after("<p class='send-ok'> Mise à jour effectuée avec succès !</p>");

      }else if(data.erreur){

        // Info générale
        $('#espace-membre-form').after("<p class='erreur-global'> Des erreurs empèchent la soumission du formulaire. Veuillez corriger les erreurs.</p>");

        // Créer un compte
        if(data.erreur_user_email) $( "#espace-membre-form input[name='user_email']" ).after(data.erreur_user_email);
        if(data.erreur_user_pass) $( "#espace-membre-form input[name='user_pass2']" ).after(data.erreur_user_pass);


        // Participant
        if(data.erreur_participant_nom) $( "input[name='participant_nom']" ).after(data.erreur_participant_nom);
        if(data.erreur_participant_prenom) $( "input[name='participant_prenom']" ).after(data.erreur_participant_prenom);
        if(data.erreur_participant_telephone) $( "input[name='participant_telephone']" ).after(data.erreur_participant_telephone);
        if(data.erreur_participant_fonction) $( "input[name='participant_fonction']" ).after(data.erreur_participant_fonction);

        // Entreprise
        if(data.erreur_entreprise_nom ) $( "input[name='entreprise_nom']" ).after(data.erreur_entreprise_nom);
        if(data.erreur_entreprise_adresse) $( "input[name='entreprise_adresse']" ).after(data.erreur_entreprise_adresse);

        //Responsable
        if(data.erreur_responsable_nom  ) $( "input[name='responsable_nom']" ).after(data.erreur_responsable_nom);
        if(data.erreur_responsable_prenom) $( "input[name='responsable_prenom']" ).after(data.erreur_responsable_prenom);
        //if(data.erreur_responsable_adresse) $( "input[name='responsable_adresse']" ).after(data.erreur_responsable_adresse);
        if(data.erreur_responsable_telephone) $( "input[name='responsable_telephone']" ).after(data.erreur_responsable_telephone);
        if(data.erreur_responsable_email) $( "input[name='responsable_email']" ).after(data.erreur_responsable_email);

        // Pee
        if(data.erreur_pee_nom_organisme) $( "input[name='pee_nom_organisme']" ).after(data.erreur_pee_nom_organisme);
        if(data.erreur_pee_adresse_organisme) $( "input[name='pee_adresse_organisme']" ).after(data.erreur_pee_adresse_organisme);
        if(data.erreur_pee_telephone_organisme) $( "input[name='pee_telephone_organisme']" ).after(data.erreur_pee_telephone_organisme);
        if(data.erreur_pee_fax_organisme) $( "input[name='pee_fax_organisme']" ).after(data.erreur_pee_fax_organisme);

        if(data.erreur_pee) $("#pee_title").after(data.erreur_pee);

        // Conditions générales
        if(data.erreur_condition_generales) $( ".condition_generales" ).after(data.erreur_condition_generales);

      }

      // Affichage erreur WP
      if(data.isWpErreur){
        $('#espace-membre-form').after('<p class="erreur-global">'+data.wpErreur+'</p>');
        $( "#espace-membre-form input[name='user_email']" ).after('<em class="erreur state-error">'+data.wpErreur+'</em>');
      }

      // Redirection du membre après connection
      if(data.registerOk && !data.isWpErreur  &&!data.erreur){

        //window.location = blogUrl+'/espace-membre/';
      }


    },
    error : function(request, errorType, errorMessage){
      console.log(request);
      console.log(errorType);
      console.log(errorMessage);
    },
    beforeSend: function(){
      //alert('Avant la requête AJAX');
      $('#contact-form').after("<i id='ajax-loader' class='fa fa-refresh fa-spin fa-2x ajax-loader'></i>");
    },
    complete:function(){
      $('#ajax-loader').remove();
    }
  });
});
// fin formulaire de contact


// Tweak sur le form

// Interdiction de 2 choix sur les checkbox

$( "input[name='pee_entreprise']" ).click(function(){
  if($(this).is(':checked')) $( "input[name='pee_organisme_payeur']" ).attr('checked', false); // Unchecks it
});

$( "input[name='pee_organisme_payeur']" ).click(function(){
  if($(this).is(':checked')) $( "input[name='pee_entreprise']" ).attr('checked', false); // Unchecks it
});

$('.home-slider').owlCarousel({
  autoplay:true,
  autoplayTimeout:8000,
  autoplayHoverPause:true,
  items:1,
  loop:true
});


/**
*  Gère l'affichage du form de connection au hover
*/
// $(".profil").mouseover(function() {
//   $('.login-form').toggleClass('hidden');
//   $(this).toggleClass('profil-active');
//   $(this).find('.icon-hover').removeClass('hidden');
//   $(this).find('.icon-default').hide();
// }).mouseout(function() {
//   $('.login-form').toggleClass('hidden');
//   $(this).toggleClass('profil-active');
//   $(this).find('.icon-hover').addClass('hidden');
//   $(this).find('.icon-default').show();
// });
//
// $(".login-form").mouseover(function() {
//   $(this).removeClass('hidden');
//   $('.profil').addClass('profil-active');
//   $(".profil").find('.icon-hover').removeClass('hidden');
//   $(".profil").find('.icon-default').hide();
// }).mouseout(function() {
//   //$(this).addClass('hidden');
//   $(".profil").find('.icon-hover').addClass('hidden');
//   $(".profil").find('.icon-default').show();
//   $('.profil').removeClass('profil-active');
// });
//
//
// /**
// *  Gère l'affichage du form de RECHERCHE au hover
// */
// $(".search").mouseover(function() {
//   $('.search-form').toggleClass('hidden');
//   $(this).toggleClass('search-active');
//   $(this).find('.icon-hover').removeClass('hidden');
//   $(this).find('.icon-default').hide();
// }).mouseout(function() {
//   $('.search-form').toggleClass('hidden');
//   $(this).toggleClass('search-active');
//
// });
//
// $('.search-form').mouseover(function() {
//   $(this).removeClass('hidden');
//   $('.search').addClass('search-active');
//
// }).mouseout(function() {
//   $(this).addClass('hidden');
//   $('.search').removeClass('search-active');
//
// });
//

function isIE(userAgent) {
  userAgent = userAgent || navigator.userAgent;
  return userAgent.indexOf("MSIE ") > -1 || userAgent.indexOf("Trident/") > -1;
}

if(isIE()){
  console.log('IS IE ');
  $(".profil").mouseover(function() {
    $(this).addClass('profil-hover-ie');
  }).mouseout(function() {
    $(this).removeClass('profil-hover-ie');
  });

  $(".header-top .search").mouseover(function() {
    $(this).addClass('search-hover-ie');
  }).mouseout(function() {
    $(this).removeClass('search-hover-ie');
  });

}

// Au click sur la loupe la recherche se lance
$('#fake-submit').click(function(){
  $('#header-search-submit').trigger('click');
});

console.log('Header Module LOADED STOPED');

}); // document ready
